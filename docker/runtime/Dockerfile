FROM python:2.7-slim

MAINTAINER Duy Nguyen <dnguyen0304@gmail.com>

ARG NAMESPACE
ARG CONFIGURATION_FILE_NAME
ARG AWS_CONFIGURATION_FILE_NAME
ARG AWS_CREDENTIALS_FILE_NAME

# unzip is needed to extract the package.
ARG BUILDTIME_DEPENDENCIES="unzip"
ARG PACKAGE="${NAMESPACE}-latest.zip"

ARG PACKAGE_DIRECTORY="/opt/${NAMESPACE}"
ARG CONFIGURATION_DIRECTORY="/etc/opt/${NAMESPACE}"
ARG LOG_DIRECTORY="/var/opt/${NAMESPACE}/log"

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends ${BUILDTIME_DEPENDENCIES}

RUN useradd ${NAMESPACE}

ENV CONFIGURATION_FILE_PATH="${CONFIGURATION_DIRECTORY}/${CONFIGURATION_FILE_NAME}"
ENV AWS_CONFIG_FILE="${CONFIGURATION_DIRECTORY}/${AWS_CONFIGURATION_FILE_NAME}"
ENV AWS_SHARED_CREDENTIALS_FILE="${CONFIGURATION_DIRECTORY}/${AWS_CREDENTIALS_FILE_NAME}"

RUN mkdir ${PACKAGE_DIRECTORY} && \
    mkdir --parent ${CONFIGURATION_DIRECTORY} && \
    mkdir --parent ${LOG_DIRECTORY}

COPY ${PACKAGE} ${PACKAGE_DIRECTORY}

WORKDIR ${PACKAGE_DIRECTORY}

RUN unzip -q ${PACKAGE} && \
    chown --recursive ${NAMESPACE}:${NAMESPACE} ${PACKAGE_DIRECTORY} && \
    chown --recursive ${NAMESPACE}:${NAMESPACE} ${CONFIGURATION_DIRECTORY} && \
    chown --recursive ${NAMESPACE}:${NAMESPACE} ${LOG_DIRECTORY}

RUN rm -fr /var/lib/apt/lists/* && \
    apt-get purge -y --auto-remove ${BUILDTIME_DEPENDENCIES}

VOLUME ${CONFIGURATION_DIRECTORY}
VOLUME ${LOG_DIRECTORY}

ENTRYPOINT ["python", "./main.py"]
